<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ReForm50 Daily Signal Log</title>
  <style>
    :root{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:#111; background:#fff;
    }
    body{ margin:18px; max-width:1024px; }
    h1{ margin:0 0 6px 0; font-size:22px; line-height:1.2; }
    .sub{ margin:0 0 18px 0; color:#444; line-height:1.35; }
    .card{ border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0; background:#fff; }
    label{ display:block; margin:10px 0 6px; font-size:13px; color:#333; }
    input,select,textarea,button{
      width:100%; font-size:16px; padding:10px;
      border-radius:12px; border:1px solid #ccc; box-sizing:border-box;
    }
    textarea{ min-height:76px; resize:vertical; }
    button{ cursor:pointer; background:#111; color:#fff; border:1px solid #111; }
    button.secondary{ background:#fff; color:#111; border:1px solid #111; }
    button.danger{ background:#b00020; border:1px solid #b00020; color:#fff; }

    .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:760px){
      .grid.two{ grid-template-columns:1fr 1fr; }
      .grid.three{ grid-template-columns:1fr 1fr 1fr; }
    }
    .btnrow{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px; }
    @media (min-width:760px){ .btnrow{ grid-template-columns:1fr 1fr 1fr; } }

    .small{ font-size:12px; color:#555; line-height:1.35; }
    .muted{ color:#666; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space:pre-wrap; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#f3f3f3; font-size:12px; }
    .right{ text-align:right; }

    .errorbox{
      display:none; margin-top:10px; padding:10px;
      border:1px solid #b00020; border-radius:12px; background:#fff5f5; color:#7a0010;
    }
    .editbar{
      display:none; margin-top:10px; padding:10px;
      border:1px solid #111; border-radius:12px; background:#fafafa;
    }
    .okbox{
      display:none; margin-top:10px; padding:10px;
      border:1px solid #0a7a2f; border-radius:12px; background:#f2fff6; color:#0a5a22;
    }

    .tableWrap{
      width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;
      border:1px solid #eee; border-radius:12px;
    }
    table{
      width:100%; min-width:980px;
      border-collapse:collapse; background:#fff;
    }
    th,td{
      border-bottom:1px solid #eee;
      padding:10px 8px; text-align:left; vertical-align:top; font-size:14px;
      white-space:normal; word-break:break-word;
    }
    th{
      position:sticky; top:0; z-index:5; background:#fff;
      font-size:12px; color:#555; text-transform:uppercase; letter-spacing:0.04em;
    }
    .nowrap{ white-space:nowrap; }

    .actionsCell{ position:relative; min-width:70px; }
    .kebab{
      width:44px; padding:8px 0; border-radius:12px;
      background:#fff; color:#111; border:1px solid #111;
      font-weight:700; line-height:1;
    }
    .menu{
      display:none; position:absolute; right:0; top:44px;
      background:#fff; border:1px solid #ddd; border-radius:12px; padding:8px;
      width:170px; box-shadow:0 10px 30px rgba(0,0,0,0.10); z-index:20;
    }
    .menu button{ width:100%; margin:6px 0; border-radius:12px; }

    @media (max-width:420px){
      body{ margin:12px; }
      h1{ font-size:20px; }
      .card{ padding:12px; }
    }
  </style>
</head>
<body>
  <h1>ReForm50 Daily Signal Log</h1>
  <p class="sub">Local-first. Entries stay on this device. Use Export + Import to move data through iCloud Drive.</p>

  <div class="card" id="clockCard">
    <div class="grid two">
      <div>
        <label>CTA test start (optional)</label>
        <input id="ctaStart" type="datetime-local" />
        <div class="small muted" style="margin-top:6px;">Use this if you changed the call-to-action and want a clean conversion clock.</div>
      </div>
      <div>
        <label>Checkpoint helper</label>
        <div class="small" id="checkpointText">Set CTA start to see the 24h, 48h, 72h checkpoints.</div>
        <div style="margin-top:8px;" class="mono" id="checkpointMono"></div>
      </div>
    </div>
    <div class="btnrow">
      <button class="secondary" id="saveCtaBtn" type="button">Save CTA Start</button>
      <button class="secondary" id="clearCtaBtn" type="button">Clear CTA Start</button>
      <button class="secondary" id="setNowBtn" type="button">Set CTA Start = Now</button>
    </div>
  </div>

  <div class="card">
    <div class="grid three">
      <div><label>Date</label><input id="date" type="date" /></div>
      <div><label>Time</label><input id="time" type="time" /></div>
      <div>
        <label>Time block</label>
        <select id="timeBlock">
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening" selected>Evening</option>
        </select>
      </div>
    </div>

    <div class="grid three">
      <div>
        <label>Platform</label>
        <select id="platform">
          <option value="Kijiji" selected>Kijiji</option>
          <option value="Facebook Marketplace">Facebook Marketplace</option>
          <option value="Facebook Group">Facebook Group</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div><label>Views</label><input id="views" type="number" inputmode="numeric" min="0" placeholder="0" /></div>
      <div><label>Clicks (or Opens)</label><input id="clicks" type="number" inputmode="numeric" min="0" placeholder="0" /></div>
    </div>

    <div class="grid three">
      <div><label>DMs</label><input id="dms" type="number" inputmode="numeric" min="0" placeholder="0" /></div>
      <div>
        <label>Credential questions?</label>
        <select id="cred">
          <option value="No" selected>No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="Running" selected>Running</option>
          <option value="Pending approval">Pending approval</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Edited">Edited</option>
        </select>
      </div>
    </div>

    <label>Notes (facts only)</label>
    <textarea id="notes" placeholder="Example: CTA added at 9:10 pm. No edits since. Post pending."></textarea>

    <div class="btnrow">
      <button id="addBtn" type="button">Add Entry</button>
      <button class="secondary" id="cancelEditBtn" type="button" style="display:none;">Cancel Edit</button>
      <button class="secondary" id="clearFormBtn" type="button">Clear Form</button>
      <button class="secondary" id="quickNowBtn" type="button">Set Date/Time = Now</button>
    </div>

    <div id="editBar" class="editbar"></div>
    <div id="okBox" class="okbox"></div>
    <div id="errorBox" class="errorbox"></div>

    <div class="small muted" style="margin-top:10px;">Decision rules: Do not change copy outside checkpoints. Checkpoints are 24h, 48h, 72h after CTA start.</div>
  </div>

  <div class="card">
    <div class="grid two">
      <div>
        <div class="small">Today totals (from saved entries)</div>
        <div style="margin-top:6px;">
          <span class="pill" id="totViews">Views: 0</span>
          <span class="pill" id="totClicks" style="margin-left:6px;">Clicks: 0</span>
          <span class="pill" id="totDMs" style="margin-left:6px;">DMs: 0</span>
        </div>
      </div>
      <div class="right">
        <div class="small muted">Backup + Restore (iCloud Drive)</div>
        <div class="btnrow" style="margin-top:8px;">
          <button class="secondary" id="exportJsonBtn" type="button">Export JSON</button>
          <button class="secondary" id="importJsonBtn" type="button">Import JSON</button>
          <button class="secondary" id="exportCsvBtn" type="button">Export CSV</button>
        </div>
        <div class="btnrow" style="margin-top:8px;">
          <button class="danger" id="wipeBtn" type="button">Wipe All Data</button>
          <button class="secondary" id="clearMenusBtn" type="button">Close Menus</button>
          <button class="secondary" id="clearMsgsBtn" type="button">Clear Messages</button>
        </div>
        <input id="importFile" type="file" accept="application/json,.json" style="display:none;" />
        <div class="small muted" style="margin-top:8px;">Tip: After Export on iPhone, choose iCloud Drive → ReForm50 → logs.</div>
      </div>
    </div>

    <div class="tableWrap">
      <table id="logTable">
        <thead>
          <tr>
            <th class="nowrap">Date</th>
            <th class="nowrap">Time</th>
            <th>Block</th>
            <th>Platform</th>
            <th class="nowrap">Views</th>
            <th class="nowrap">Clicks</th>
            <th class="nowrap">DMs</th>
            <th>Cred</th>
            <th>Status</th>
            <th>Notes</th>
            <th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>

    <div class="small muted" style="margin-top:10px;">On iPhone: open this page in Safari, then Share → Add to Home Screen.</div>
  </div>

<script>
  const STORAGE_KEY = "reform50_signal_log_v2";
  const CTA_KEY = "reform50_cta_start_v1";
  let editingId = null;
  let openMenuForId = null;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function nowLocalDate(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function nowLocalTime(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

  function loadEntries(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function saveEntries(entries){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

  function loadCta(){ return localStorage.getItem(CTA_KEY) || ""; }
  function saveCta(val){ localStorage.setItem(CTA_KEY, val); }
  function clearCta(){ localStorage.removeItem(CTA_KEY); }

  function setFormNow(){
    document.getElementById("date").value = nowLocalDate();
    document.getElementById("time").value = nowLocalTime();
  }
  function toInt(v){
    const n = parseInt(v, 10);
    return Number.isFinite(n) && n >= 0 ? n : 0;
  }

  function showOk(msg){
    const box = document.getElementById("okBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function showError(msg){
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function clearMsgs(){
    document.getElementById("okBox").style.display = "none";
    document.getElementById("okBox").textContent = "";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("errorBox").textContent = "";
  }

  function renderCheckpoint(){
    const cta = loadCta();
    const text = document.getElementById("checkpointText");
    const mono = document.getElementById("checkpointMono");
    if(!cta){
      text.textContent = "Set CTA start to see the 24h, 48h, 72h checkpoints.";
      mono.textContent = "";
      return;
    }
    const start = new Date(cta);
    if(Number.isNaN(start.getTime())){
      text.textContent = "CTA start value is invalid.";
      mono.textContent = "";
      return;
    }
    const h24 = new Date(start.getTime() + 24*60*60*1000);
    const h48 = new Date(start.getTime() + 48*60*60*1000);
    const h72 = new Date(start.getTime() + 72*60*60*1000);

    const fmt = (d) => {
      const yyyy=d.getFullYear();
      const mm=pad2(d.getMonth()+1);
      const dd=pad2(d.getDate());
      const hh=pad2(d.getHours());
      const mi=pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    };

    text.textContent = "Checkpoints based on CTA start:";
    mono.textContent =
      "CTA start: " + fmt(start) + "\n" +
      "24h:       " + fmt(h24) + "\n" +
      "48h:       " + fmt(h48) + "\n" +
      "72h:       " + fmt(h72);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      "\"":"&quot;",
      "'":"&#39;"
    }[m]));
  }

  function cryptoRandomId(){
    if (window.crypto && crypto.getRandomValues){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return a[0].toString(16) + a[1].toString(16);
    }
    return String(Date.now()) + Math.random().toString(16).slice(2);
  }

  function closeAllMenus(){
    document.querySelectorAll(".menu").forEach(m => m.style.display = "none");
    openMenuForId = null;
  }

  function renderTable(){
    const entries = loadEntries();
    entries.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));

    const body = document.getElementById("logBody");
    body.innerHTML = "";

    const today = nowLocalDate();
    let tv=0, tc=0, td=0;

    for (const e of entries){
      if(e.date === today){
        tv += e.views;
        tc += e.clicks;
        td += e.dms;
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${escapeHtml(e.date)}</td>
        <td class="nowrap">${escapeHtml(e.time)}</td>
        <td>${escapeHtml(e.timeBlock)}</td>
        <td>${escapeHtml(e.platform)}</td>
        <td class="nowrap">${e.views}</td>
        <td class="nowrap">${e.clicks}</td>
        <td class="nowrap">${e.dms}</td>
        <td>${escapeHtml(e.cred)}</td>
        <td>${escapeHtml(e.status)}</td>
        <td>${escapeHtml(e.notes || "")}</td>
        <td class="actionsCell nowrap">
          <button class="kebab" data-more="${e.id}" type="button">⋯</button>
          <div class="menu" id="menu-${e.id}">
            <button class="secondary" data-edit="${e.id}" type="button">Edit</button>
            <button class="danger" data-del="${e.id}" type="button">Delete</button>
          </div>
        </td>
      `;
      body.appendChild(tr);
    }

    document.getElementById("totViews").textContent = "Views: " + tv;
    document.getElementById("totClicks").textContent = "Clicks: " + tc;
    document.getElementById("totDMs").textContent = "DMs: " + td;

    body.querySelectorAll("button[data-more]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute("data-more");
        const menu = document.getElementById("menu-" + id);
        if(!menu) return;

        if(openMenuForId && openMenuForId !== id){ closeAllMenus(); }
        const isOpen = (menu.style.display === "block");
        closeAllMenus();
        if(!isOpen){
          menu.style.display = "block";
          openMenuForId = id;

          const rect = menu.getBoundingClientRect();
          if(rect.right > window.innerWidth){
            menu.style.right = "auto";
            menu.style.left = "0";
          } else {
            menu.style.left = "auto";
            menu.style.right = "0";
          }
        }
      });
    });

    body.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute("data-del");
        const updated = loadEntries().filter(x => x.id !== id);
        saveEntries(updated);
        if(editingId === id){ cancelEdit(); }
        closeAllMenus();
        renderTable();
      });
    });

    body.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute("data-edit");
        closeAllMenus();
        startEdit(id);
      });
    });
  }

  function downloadFile(name, content, type){
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportJson(){
    const data = {
      exportedAt: new Date().toISOString(),
      ctaStart: loadCta() || null,
      entries: loadEntries()
    };
    downloadFile("ReForm50_signal_log.json", JSON.stringify(data, null, 2), "application/json");
  }

  function exportCsv(){
    const entries = loadEntries();
    const header = ["date","time","time_block","platform","views","clicks","dms","credential_questions","status","notes","created_at","updated_at"];
    const rows = [header.join(",")];
    for(const e of entries){
      const row = [
        e.date, e.time, e.timeBlock, e.platform,
        e.views, e.clicks, e.dms,
        e.cred, e.status,
        (e.notes || "").replaceAll('"','""'),
        e.createdAt || "",
        e.updatedAt || ""
      ].map(v => {
        const s = String(v);
        if(/[,\n"]/.test(s)){ return `"${s.replaceAll('"','""')}"`; }
        return s;
      });
      rows.push(row.join(","));
    }
    downloadFile("ReForm50_signal_log.csv", rows.join("\n"), "text/csv");
  }

  function wipeAll(){
    const ok = confirm("Wipe all saved log data on this device?");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    cancelEdit();
    closeAllMenus();
    renderTable();
    showOk("All data wiped on this device.");
  }

  function getFormData(){
    return {
      date: document.getElementById("date").value || nowLocalDate(),
      time: document.getElementById("time").value || nowLocalTime(),
      timeBlock: document.getElementById("timeBlock").value,
      platform: document.getElementById("platform").value,
      views: toInt(document.getElementById("views").value),
      clicks: toInt(document.getElementById("clicks").value),
      dms: toInt(document.getElementById("dms").value),
      cred: document.getElementById("cred").value,
      status: document.getElementById("status").value,
      notes: document.getElementById("notes").value.trim()
    };
  }

  function fillForm(e){
    document.getElementById("date").value = e.date;
    document.getElementById("time").value = e.time;
    document.getElementById("timeBlock").value = e.timeBlock;
    document.getElementById("platform").value = e.platform;
    document.getElementById("views").value = e.views;
    document.getElementById("clicks").value = e.clicks;
    document.getElementById("dms").value = e.dms;
    document.getElementById("cred").value = e.cred;
    document.getElementById("status").value = e.status;
    document.getElementById("notes").value = e.notes || "";
  }

  function clearForm(){
    document.getElementById("views").value = "";
    document.getElementById("clicks").value = "";
    document.getElementById("dms").value = "";
    document.getElementById("notes").value = "";
  }

  function startEdit(id){
    const entries = loadEntries();
    const e = entries.find(x => x.id === id);
    if(!e) return;
    editingId = id;
    fillForm(e);
    document.getElementById("addBtn").textContent = "Save Changes";
    document.getElementById("cancelEditBtn").style.display = "block";
    document.getElementById("editBar").style.display = "block";
    document.getElementById("editBar").textContent = "Editing entry. Make changes above, then click Save Changes.";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function cancelEdit(){
    editingId = null;
    document.getElementById("addBtn").textContent = "Add Entry";
    document.getElementById("cancelEditBtn").style.display = "none";
    document.getElementById("editBar").style.display = "none";
    document.getElementById("editBar").textContent = "";
    clearForm();
  }

  function addOrSave(){
    try{
      clearMsgs();
      const data = getFormData();
      const entries = loadEntries();

      if(editingId){
        const idx = entries.findIndex(x => x.id === editingId);
        if(idx === -1){
          cancelEdit();
          showError("Could not find that entry to edit. It may have been deleted.");
          return;
        }
        const old = entries[idx];
        entries[idx] = { ...old, ...data, updatedAt: new Date().toISOString() };
        saveEntries(entries);
        cancelEdit();
        renderTable();
        showOk("Entry updated.");
        return;
      }

      const entry = { id: cryptoRandomId(), ...data, createdAt: new Date().toISOString() };
      entries.push(entry);
      saveEntries(entries);
      renderTable();
      clearForm();
      showOk("Entry added.");
    } catch(err){
      showError("Save failed: " + (err && err.message ? err.message : String(err)));
    }
  }

  // IMPORT JSON
  function normalizeImportedEntries(arr){
    // Ensure each entry has required fields. Keep any extra fields.
    const out = [];
    for(const raw of arr){
      if(!raw || typeof raw !== "object") continue;
      const e = { ...raw };

      // Minimal defaults
      e.id = (typeof e.id === "string" && e.id.length > 0) ? e.id : cryptoRandomId();
      e.date = (typeof e.date === "string" && e.date.length >= 8) ? e.date : nowLocalDate();
      e.time = (typeof e.time === "string" && e.time.length >= 3) ? e.time : nowLocalTime();
      e.timeBlock = (typeof e.timeBlock === "string" && e.timeBlock.length) ? e.timeBlock : "Evening";
      e.platform = (typeof e.platform === "string" && e.platform.length) ? e.platform : "Other";
      e.views = Number.isFinite(parseInt(e.views,10)) ? parseInt(e.views,10) : 0;
      e.clicks = Number.isFinite(parseInt(e.clicks,10)) ? parseInt(e.clicks,10) : 0;
      e.dms = Number.isFinite(parseInt(e.dms,10)) ? parseInt(e.dms,10) : 0;
      e.cred = (e.cred === "Yes" || e.cred === "No") ? e.cred : "No";
      e.status = (typeof e.status === "string" && e.status.length) ? e.status : "Running";
      e.notes = (typeof e.notes === "string") ? e.notes : "";
      e.createdAt = (typeof e.createdAt === "string" && e.createdAt.length) ? e.createdAt : new Date().toISOString();

      out.push(e);
    }
    return out;
  }

  function mergeById(existing, incoming){
    const map = new Map();
    for(const e of existing){ map.set(e.id, e); }
    for(const e of incoming){
      if(!map.has(e.id)){
        map.set(e.id, e);
      } else {
        // Keep the newer one if updatedAt exists, else keep existing.
        const cur = map.get(e.id);
        const curT = Date.parse(cur.updatedAt || cur.createdAt || "");
        const inT = Date.parse(e.updatedAt || e.createdAt || "");
        if(Number.isFinite(inT) && (!Number.isFinite(curT) || inT >= curT)){
          map.set(e.id, { ...cur, ...e });
        }
      }
    }
    return Array.from(map.values());
  }

  function handleImportText(jsonText){
    let parsed;
    try{
      parsed = JSON.parse(jsonText);
    } catch(err){
      showError("Import failed. File is not valid JSON.");
      return;
    }

    // Accept either {entries:[...], ctaStart:"..."} or just an array of entries.
    let incomingEntries = [];
    let incomingCta = null;

    if(Array.isArray(parsed)){
      incomingEntries = parsed;
    } else if(parsed && typeof parsed === "object"){
      if(Array.isArray(parsed.entries)) incomingEntries = parsed.entries;
      if(typeof parsed.ctaStart === "string") incomingCta = parsed.ctaStart;
    }

    const normalized = normalizeImportedEntries(incomingEntries);
    if(normalized.length === 0){
      showError("Import failed. No entries found in that file.");
      return;
    }

    const replace = confirm("Import mode:\n\nOK = Replace all current entries on this device\nCancel = Merge with existing entries\n\n(You can export first if you want a backup.)");
    const current = loadEntries();
    const finalEntries = replace ? normalized : mergeById(current, normalized);
    saveEntries(finalEntries);

    // CTA start import (optional)
    if(incomingCta){
      try{
        const d = new Date(incomingCta);
        if(!Number.isNaN(d.getTime())){
          saveCta(incomingCta);
          document.getElementById("ctaStart").value = incomingCta;
          renderCheckpoint();
        }
      } catch(e){}
    }

    renderTable();
    showOk(replace
      ? ("Imported " + normalized.length + " entries (replaced).")
      : ("Imported " + normalized.length + " entries (merged). Total now: " + finalEntries.length + "."));
  }

  function importJson(){
    clearMsgs();
    const input = document.getElementById("importFile");
    input.value = "";
    input.click();
  }

  function init(){
    document.getElementById("ctaStart").value = loadCta();
    renderCheckpoint();
    setFormNow();
    renderTable();

    document.getElementById("addBtn").addEventListener("click", addOrSave);
    document.getElementById("cancelEditBtn").addEventListener("click", cancelEdit);
    document.getElementById("clearFormBtn").addEventListener("click", () => { clearForm(); clearMsgs(); });
    document.getElementById("quickNowBtn").addEventListener("click", setFormNow);

    document.getElementById("exportJsonBtn").addEventListener("click", () => { clearMsgs(); exportJson(); });
    document.getElementById("exportCsvBtn").addEventListener("click", () => { clearMsgs(); exportCsv(); });
    document.getElementById("importJsonBtn").addEventListener("click", importJson);
    document.getElementById("wipeBtn").addEventListener("click", wipeAll);

    document.getElementById("clearMenusBtn").addEventListener("click", closeAllMenus);
    document.getElementById("clearMsgsBtn").addEventListener("click", clearMsgs);

    document.getElementById("importFile").addEventListener("change", async (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        handleImportText(text);
      } catch(err){
        showError("Import failed. Could not read the file.");
      }
    });

    document.getElementById("saveCtaBtn").addEventListener("click", () => {
      const v = document.getElementById("ctaStart").value;
      if(!v){ alert("CTA start is blank."); return; }
      saveCta(v);
      renderCheckpoint();
      showOk("CTA start saved.");
    });
    document.getElementById("clearCtaBtn").addEventListener("click", () => {
      clearCta();
      document.getElementById("ctaStart").value = "";
      renderCheckpoint();
      showOk("CTA start cleared.");
    });
    document.getElementById("setNowBtn").addEventListener("click", () => {
      const d = new Date();
      const val = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      document.getElementById("ctaStart").value = val;
      saveCta(val);
      renderCheckpoint();
      showOk("CTA start set to now.");
    });

    // Close menus on outside interactions
    document.addEventListener("click", () => closeAllMenus());
    document.addEventListener("scroll", () => closeAllMenus(), { passive:true });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape"){ closeAllMenus(); } });

    // Basic runtime error surface
    window.addEventListener("error", (e) => { showError("Error: " + (e.message || "Unknown error")); });
  }

  init();
</script>
</body>
</html>

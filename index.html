<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReForm50 Daily Signal Log</title>
  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    body { margin: 18px; max-width: 980px; }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    .sub { margin: 0 0 18px 0; color: #444; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 12px 0; }
    label { display: block; margin: 10px 0 6px; font-size: 13px; color: #333; }
    input, select, textarea, button { width: 100%; font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box; }
    textarea { min-height: 70px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 760px) {
      .row.two { grid-template-columns: 1fr 1fr; }
      .row.three { grid-template-columns: 1fr 1fr 1fr; }
    }
    .btnrow { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    @media (min-width: 760px) { .btnrow { grid-template-columns: 1fr 1fr 1fr; } }
    button { cursor: pointer; background: #111; color: #fff; border: 1px solid #111; }
    button.secondary { background: #fff; color: #111; border: 1px solid #111; }
    button.danger { background: #b00020; border: 1px solid #b00020; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; vertical-align: top; font-size: 14px; }
    th { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 0.04em; }
    .small { font-size: 12px; color: #555; line-height: 1.35; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f3f3f3; font-size: 12px; }
    .muted { color: #666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; white-space: pre-wrap; }
    .nowrap { white-space: nowrap; }
    .right { text-align: right; }
    .errorbox { display:none; margin-top:10px; padding:10px; border:1px solid #b00020; border-radius:10px; background:#fff5f5; color:#7a0010; }
    .editbar { display:none; margin-top:10px; padding:10px; border:1px solid #111; border-radius:10px; background:#fafafa; }

    /* Action menu */
    .actionsCell { position: relative; min-width: 70px; }
    .kebab {
      width: 44px;
      padding: 8px 0;
      border-radius: 10px;
      background: #fff;
      color: #111;
      border: 1px solid #111;
      font-weight: 700;
      line-height: 1;
    }
    .menu {
      display: none;
      position: absolute;
      right: 0;
      top: 42px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 8px;
      width: 160px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      z-index: 20;
    }
    .menu button { width: 100%; margin: 6px 0; }
    .menu button.secondary { background:#fff; color:#111; border:1px solid #111; }
    .menu button.danger { background:#b00020; color:#fff; border:1px solid #b00020; }
  </style>
</head>
<body>
  <h1>ReForm50 Daily Signal Log</h1>
  <p class="sub">Local-first. Everything stays on this device unless you export.</p>

  <div class="card" id="clockCard">
    <div class="row two">
      <div>
        <label>CTA test start (optional)</label>
        <input id="ctaStart" type="datetime-local" />
        <div class="small muted" style="margin-top:6px;">
          Use this if you changed the call-to-action and want a clean conversion clock.
        </div>
      </div>
      <div>
        <label>Checkpoint helper</label>
        <div class="small" id="checkpointText">Set CTA start to see the 24h, 48h, 72h checkpoints.</div>
        <div style="margin-top:8px;" class="mono" id="checkpointMono"></div>
      </div>
    </div>
    <div class="btnrow">
      <button class="secondary" id="saveCtaBtn" type="button">Save CTA Start</button>
      <button class="secondary" id="clearCtaBtn" type="button">Clear CTA Start</button>
      <button class="secondary" id="setNowBtn" type="button">Set CTA Start = Now</button>
    </div>
  </div>

  <div class="card">
    <div class="row three">
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>Time</label>
        <input id="time" type="time" />
      </div>
      <div>
        <label>Time block</label>
        <select id="timeBlock">
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening" selected>Evening</option>
        </select>
      </div>
    </div>

    <div class="row three">
      <div>
        <label>Platform</label>
        <select id="platform">
          <option value="Kijiji" selected>Kijiji</option>
          <option value="Facebook Marketplace">Facebook Marketplace</option>
          <option value="Facebook Group">Facebook Group</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label>Views</label>
        <input id="views" type="number" inputmode="numeric" min="0" placeholder="0" />
      </div>
      <div>
        <label>Clicks (or Opens)</label>
        <input id="clicks" type="number" inputmode="numeric" min="0" placeholder="0" />
      </div>
    </div>

    <div class="row three">
      <div>
        <label>DMs</label>
        <input id="dms" type="number" inputmode="numeric" min="0" placeholder="0" />
      </div>
      <div>
        <label>Credential questions?</label>
        <select id="cred">
          <option value="No" selected>No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="Running" selected>Running</option>
          <option value="Pending approval">Pending approval</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Edited">Edited</option>
        </select>
      </div>
    </div>

    <label>Notes (facts only)</label>
    <textarea id="notes" placeholder="Example: CTA added at 9:10 pm. No edits since. Post pending."></textarea>

    <div class="btnrow">
      <button id="addBtn" type="button">Add Entry</button>
      <button class="secondary" id="cancelEditBtn" type="button" style="display:none;">Cancel Edit</button>
      <button class="secondary" id="clearFormBtn" type="button">Clear Form</button>
      <button class="secondary" id="quickNowBtn" type="button">Set Date/Time = Now</button>
    </div>

    <div id="editBar" class="editbar"></div>
    <div id="errorBox" class="errorbox"></div>

    <div class="small muted" style="margin-top:10px;">
      Decision rules: Do not change copy outside checkpoints. Checkpoints are 24h, 48h, 72h after CTA start.
    </div>
  </div>

  <div class="card">
    <div class="row two">
      <div>
        <div class="small">Today totals (from saved entries)</div>
        <div style="margin-top:6px;">
          <span class="pill" id="totViews">Views: 0</span>
          <span class="pill" id="totClicks" style="margin-left:6px;">Clicks: 0</span>
          <span class="pill" id="totDMs" style="margin-left:6px;">DMs: 0</span>
        </div>
      </div>
      <div class="right">
        <div class="small muted">Exports</div>
        <div class="btnrow" style="margin-top:8px;">
          <button class="secondary" id="exportCsvBtn" type="button">Export CSV</button>
          <button class="secondary" id="exportJsonBtn" type="button">Export JSON</button>
          <button class="danger" id="wipeBtn" type="button">Wipe All Data</button>
        </div>
      </div>
    </div>

    <table id="logTable">
      <thead>
        <tr>
          <th class="nowrap">Date</th>
          <th class="nowrap">Time</th>
          <th>Block</th>
          <th>Platform</th>
          <th class="nowrap">Views</th>
          <th class="nowrap">Clicks</th>
          <th class="nowrap">DMs</th>
          <th>Cred</th>
          <th>Status</th>
          <th>Notes</th>
          <th class="nowrap">Actions</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>

    <div class="small muted" style="margin-top:10px;">
      Tip: On iPhone, use Share → Add to Home Screen from Safari for one-tap access.
    </div>
  </div>

<script>
  // Keep the same storage key as your current EDIT version so you don't lose data.
  const STORAGE_KEY = "reform50_signal_log_v2";
  const CTA_KEY = "reform50_cta_start_v1";
  let editingId = null;
  let openMenuForId = null;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function nowLocalDate(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function nowLocalTime(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

  function loadEntries(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function saveEntries(entries){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  }

  function loadCta(){ return localStorage.getItem(CTA_KEY) || ""; }
  function saveCta(val){ localStorage.setItem(CTA_KEY, val); }
  function clearCta(){ localStorage.removeItem(CTA_KEY); }

  function setFormNow(){
    document.getElementById("date").value = nowLocalDate();
    document.getElementById("time").value = nowLocalTime();
  }

  function toInt(v){
    const n = parseInt(v, 10);
    return Number.isFinite(n) && n >= 0 ? n : 0;
  }

  function renderCheckpoint(){
    const cta = loadCta();
    const text = document.getElementById("checkpointText");
    const mono = document.getElementById("checkpointMono");
    if(!cta){
      text.textContent = "Set CTA start to see the 24h, 48h, 72h checkpoints.";
      mono.textContent = "";
      return;
    }
    const start = new Date(cta);
    if(Number.isNaN(start.getTime())){
      text.textContent = "CTA start value is invalid.";
      mono.textContent = "";
      return;
    }
    const h24 = new Date(start.getTime() + 24*60*60*1000);
    const h48 = new Date(start.getTime() + 48*60*60*1000);
    const h72 = new Date(start.getTime() + 72*60*60*1000);

    const fmt = (d) => {
      const yyyy=d.getFullYear();
      const mm=pad2(d.getMonth()+1);
      const dd=pad2(d.getDate());
      const hh=pad2(d.getHours());
      const mi=pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    };

    text.textContent = "Checkpoints based on CTA start:";
    mono.textContent =
      "CTA start: " + fmt(start) + "\n" +
      "24h:       " + fmt(h24) + "\n" +
      "48h:       " + fmt(h48) + "\n" +
      "72h:       " + fmt(h72);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      "\"":"&quot;",
      "'":"&#39;"
    }[m]));
  }

  function cryptoRandomId(){
    if (window.crypto && crypto.getRandomValues){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return a[0].toString(16) + a[1].toString(16);
    }
    return String(Date.now()) + Math.random().toString(16).slice(2);
  }

  function closeAllMenus(){
    document.querySelectorAll(".menu").forEach(m => m.style.display = "none");
    openMenuForId = null;
  }

  function renderTable(){
    const entries = loadEntries();
    entries.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));

    const body = document.getElementById("logBody");
    body.innerHTML = "";

    const today = nowLocalDate();
    let tv=0, tc=0, td=0;

    for (const e of entries){
      if(e.date === today){
        tv += e.views;
        tc += e.clicks;
        td += e.dms;
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${escapeHtml(e.date)}</td>
        <td class="nowrap">${escapeHtml(e.time)}</td>
        <td>${escapeHtml(e.timeBlock)}</td>
        <td>${escapeHtml(e.platform)}</td>
        <td class="nowrap">${e.views}</td>
        <td class="nowrap">${e.clicks}</td>
        <td class="nowrap">${e.dms}</td>
        <td>${escapeHtml(e.cred)}</td>
        <td>${escapeHtml(e.status)}</td>
        <td>${escapeHtml(e.notes || "")}</td>
        <td class="actionsCell nowrap">
          <button class="kebab" data-more="${e.id}" type="button">⋯</button>
          <div class="menu" id="menu-${e.id}">
            <button class="secondary" data-edit="${e.id}" type="button">Edit</button>
            <button class="danger" data-del="${e.id}" type="button">Delete</button>
          </div>
        </td>
      `;
      body.appendChild(tr);
    }

    document.getElementById("totViews").textContent = "Views: " + tv;
    document.getElementById("totClicks").textContent = "Clicks: " + tc;
    document.getElementById("totDMs").textContent = "DMs: " + td;

    // Actions
    body.querySelectorAll("button[data-more]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute("data-more");
        const menu = document.getElementById("menu-" + id);
        if(!menu) return;

        // toggle
        if(openMenuForId && openMenuForId !== id){
          closeAllMenus();
        }
        const isOpen = (menu.style.display === "block");
        closeAllMenus();
        if(!isOpen){
          menu.style.display = "block";
          openMenuForId = id;
        }
      });
    });

    body.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute("data-del");
        const updated = loadEntries().filter(x => x.id !== id);
        saveEntries(updated);
        if(editingId === id){ cancelEdit(); }
        closeAllMenus();
        renderTable();
      });
    });

    body.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute("data-edit");
        closeAllMenus();
        startEdit(id);
      });
    });
  }

  function downloadFile(name, content, type){
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportJson(){
    const data = {
      exportedAt: new Date().toISOString(),
      ctaStart: loadCta() || null,
      entries: loadEntries()
    };
    downloadFile("ReForm50_signal_log.json", JSON.stringify(data, null, 2), "application/json");
  }

  function exportCsv(){
    const entries = loadEntries();
    const header = ["date","time","time_block","platform","views","clicks","dms","credential_questions","status","notes","created_at"];
    const rows = [header.join(",")];
    for(const e of entries){
      const row = [
        e.date, e.time, e.timeBlock, e.platform,
        e.views, e.clicks, e.dms,
        e.cred, e.status,
        (e.notes || "").replaceAll('"','""'),
        e.createdAt
      ].map((v) => {
        const s = String(v);
        if(/[,\n"]/.test(s)){ return `"${s.replaceAll('"','""')}"`; }
        return s;
      });
      rows.push(row.join(","));
    }
    downloadFile("ReForm50_signal_log.csv", rows.join("\n"), "text/csv");
  }

  function wipeAll(){
    const ok = confirm("Wipe all saved log data on this device?");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    cancelEdit();
    closeAllMenus();
    renderTable();
  }

  function showError(msg){
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function clearError(){
    const box = document.getElementById("errorBox");
    box.style.display = "none";
    box.textContent = "";
  }
  function showEditBar(msg){
    const bar = document.getElementById("editBar");
    bar.style.display = "block";
    bar.textContent = msg;
  }
  function hideEditBar(){
    const bar = document.getElementById("editBar");
    bar.style.display = "none";
    bar.textContent = "";
  }

  window.addEventListener("error", (e) => {
    showError("Error: " + (e.message || "Unknown error"));
  });

  function getFormData(){
    return {
      date: document.getElementById("date").value || nowLocalDate(),
      time: document.getElementById("time").value || nowLocalTime(),
      timeBlock: document.getElementById("timeBlock").value,
      platform: document.getElementById("platform").value,
      views: toInt(document.getElementById("views").value),
      clicks: toInt(document.getElementById("clicks").value),
      dms: toInt(document.getElementById("dms").value),
      cred: document.getElementById("cred").value,
      status: document.getElementById("status").value,
      notes: document.getElementById("notes").value.trim()
    };
  }

  function fillForm(e){
    document.getElementById("date").value = e.date;
    document.getElementById("time").value = e.time;
    document.getElementById("timeBlock").value = e.timeBlock;
    document.getElementById("platform").value = e.platform;
    document.getElementById("views").value = e.views;
    document.getElementById("clicks").value = e.clicks;
    document.getElementById("dms").value = e.dms;
    document.getElementById("cred").value = e.cred;
    document.getElementById("status").value = e.status;
    document.getElementById("notes").value = e.notes || "";
  }

  function clearForm(){
    document.getElementById("views").value = "";
    document.getElementById("clicks").value = "";
    document.getElementById("dms").value = "";
    document.getElementById("notes").value = "";
  }

  function startEdit(id){
    const entries = loadEntries();
    const e = entries.find(x => x.id === id);
    if(!e){ return; }
    editingId = id;
    fillForm(e);
    document.getElementById("addBtn").textContent = "Save Changes";
    document.getElementById("cancelEditBtn").style.display = "block";
    showEditBar("Editing entry. Make changes above, then click Save Changes.");
    clearError();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function cancelEdit(){
    editingId = null;
    document.getElementById("addBtn").textContent = "Add Entry";
    document.getElementById("cancelEditBtn").style.display = "none";
    hideEditBar();
    clearForm();
    clearError();
  }

  function addOrSave(){
    try{
      clearError();
      const data = getFormData();
      const entries = loadEntries();

      if(editingId){
        const idx = entries.findIndex(x => x.id === editingId);
        if(idx === -1){
          cancelEdit();
          showError("Could not find that entry to edit. It may have been deleted.");
          return;
        }
        const old = entries[idx];
        entries[idx] = { ...old, ...data, updatedAt: new Date().toISOString() };
        saveEntries(entries);
        cancelEdit();
        renderTable();
        return;
      }

      const entry = {
        id: cryptoRandomId(),
        ...data,
        createdAt: new Date().toISOString()
      };
      entries.push(entry);
      saveEntries(entries);
      renderTable();
      clearForm();
    } catch(err){
      showError("Save failed: " + (err && err.message ? err.message : String(err)));
    }
  }

  function init(){
    document.getElementById("ctaStart").value = loadCta();
    renderCheckpoint();
    setFormNow();
    renderTable();

    document.getElementById("addBtn").addEventListener("click", addOrSave);
    document.getElementById("cancelEditBtn").addEventListener("click", cancelEdit);
    document.getElementById("clearFormBtn").addEventListener("click", () => { clearForm(); clearError(); });
    document.getElementById("quickNowBtn").addEventListener("click", setFormNow);

    document.getElementById("exportJsonBtn").addEventListener("click", exportJson);
    document.getElementById("exportCsvBtn").addEventListener("click", exportCsv);
    document.getElementById("wipeBtn").addEventListener("click", wipeAll);

    document.getElementById("saveCtaBtn").addEventListener("click", () => {
      const v = document.getElementById("ctaStart").value;
      if(!v){ alert("CTA start is blank."); return; }
      saveCta(v);
      renderCheckpoint();
      alert("Saved.");
    });
    document.getElementById("clearCtaBtn").addEventListener("click", () => {
      clearCta();
      document.getElementById("ctaStart").value = "";
      renderCheckpoint();
    });
    document.getElementById("setNowBtn").addEventListener("click", () => {
      const d = new Date();
      const val = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      document.getElementById("ctaStart").value = val;
      saveCta(val);
      renderCheckpoint();
    });

    // Close menus when clicking elsewhere
    document.addEventListener("click", () => closeAllMenus());
    document.addEventListener("scroll", () => closeAllMenus(), { passive: true });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape"){ closeAllMenus(); } });
  }

  init();
</script>
</body>
</html>
